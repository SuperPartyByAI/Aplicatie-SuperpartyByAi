import{d as p,j as t}from"./index-vn_HUwH-.js";import{b as r}from"./react-vendor-BCFq-EBz.js";import{G as w,M as v,K as j,H as f,P as S,u as E,O as $}from"./firebase-CZFSqwcK.js";const q="https://whats-upp-production.up.railway.app";function J(){const[d,C]=r.useState(null),[g,A]=r.useState([]),[n,D]=r.useState(null),[M,u]=r.useState([]),[a,h]=r.useState(""),[k,x]=r.useState(!0),[c,m]=r.useState(!1);r.useEffect(()=>{R()},[]),r.useEffect(()=>{if(!d)return;console.log("üì° Setting up real-time listener for threads...");const e=w(f(p,"threads"),j("lastMessageAt","desc"),v(50)),s=S(e,o=>{const i=o.docs.map(l=>({id:l.id,...l.data()}));console.log(`üì• Received ${i.length} threads`),A(i),x(!1)},o=>{console.error("‚ùå Error listening to threads:",o),x(!1)});return()=>s()},[d]),r.useEffect(()=>{if(!n)return;console.log(`üì° Setting up real-time listener for messages in thread ${n.id}...`);const e=w(f(p,"threads",n.id,"messages"),j("tsClient","asc"),v(100)),s=S(e,o=>{const i=o.docs.map(l=>({id:l.id,...l.data()}));console.log(`üì• Received ${i.length} messages for thread ${n.id}`),u(i)},o=>{console.error("‚ùå Error listening to messages:",o)});return()=>s()},[n]);const R=async()=>{try{const s=await(await fetch(`${q}/api/whatsapp/accounts`)).json();if(s.accounts&&s.accounts.length>0){const o=s.accounts.find(i=>i.status==="connected");o?(C(o),console.log("‚úÖ Connected account:",o.id)):console.warn("‚ö†Ô∏è No connected WhatsApp account")}}catch(e){console.error("‚ùå Failed to load accounts:",e)}},y=async()=>{if(!(!a.trim()||!n||!d)){m(!0);try{const e={accountId:d.id,toJid:n.clientJid,payload:{text:a},body:a,status:"queued",createdAt:E(),attempts:0,requestId:`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};await $(f(p,"outbox"),e),console.log("‚úÖ Message queued in outbox");const s={id:`temp_${Date.now()}`,accountId:d.id,clientJid:n.clientJid,direction:"outbound",body:a,status:"queued",tsClient:new Date().toISOString(),createdAt:{seconds:Date.now()/1e3}};u(o=>[...o,s]),h("")}catch(e){console.error("‚ùå Failed to send message:",e),alert("‚ùå Eroare la trimiterea mesajului")}finally{m(!1)}}},T=e=>{D(e),u([])},b=e=>{if(!e)return"";let s;if(e.seconds)s=new Date(e.seconds*1e3);else if(typeof e=="string")s=new Date(e);else return"";const i=new Date-s;return Math.floor(i/(1e3*60*60))<24?s.toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("ro-RO",{day:"2-digit",month:"2-digit"})};return k?t.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#9ca3af"},children:"Se √ÆncarcƒÉ conversa»õiile..."}):d?t.jsxs("div",{style:{display:"flex",gap:"1rem",height:"600px",background:"#1f2937",borderRadius:"8px",overflow:"hidden"},children:[t.jsxs("div",{style:{width:"300px",borderRight:"1px solid #374151",display:"flex",flexDirection:"column"},children:[t.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #374151",fontWeight:"600",color:"white"},children:["üí¨ Conversa»õii (",g.length,")"]}),t.jsx("div",{style:{flex:1,overflowY:"auto"},children:g.map(e=>t.jsxs("div",{onClick:()=>T(e),style:{padding:"1rem",borderBottom:"1px solid #374151",cursor:"pointer",background:n?.id===e.id?"#374151":"transparent",transition:"background 0.2s"},onMouseEnter:s=>{n?.id!==e.id&&(s.currentTarget.style.background="#2d3748")},onMouseLeave:s=>{n?.id!==e.id&&(s.currentTarget.style.background="transparent")},children:[t.jsx("div",{style:{fontWeight:"500",color:"white",marginBottom:"0.25rem"},children:e.clientJid?.split("@")[0]||"Unknown"}),t.jsx("div",{style:{fontSize:"0.875rem",color:"#9ca3af",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.lastMessageBody||"No messages"}),t.jsx("div",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem"},children:b(e.lastMessageAt)})]},e.id))})]}),t.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:n?t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{padding:"1rem",borderBottom:"1px solid #374151",fontWeight:"600",color:"white"},children:n.clientJid?.split("@")[0]||"Unknown"}),t.jsx("div",{style:{flex:1,overflowY:"auto",padding:"1rem",display:"flex",flexDirection:"column",gap:"0.5rem"},children:M.map(e=>t.jsxs("div",{style:{alignSelf:e.direction==="outbound"?"flex-end":"flex-start",maxWidth:"70%"},children:[t.jsx("div",{style:{padding:"0.75rem",borderRadius:"8px",background:e.direction==="outbound"?"#3b82f6":"#374151",color:"white"},children:e.body}),t.jsxs("div",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem",textAlign:e.direction==="outbound"?"right":"left"},children:[b(e.tsClient||e.createdAt)," ",e.status==="queued"&&"‚è≥",e.status==="sent"&&"‚úì",e.status==="delivered"&&"‚úì‚úì",e.status==="failed"&&"‚ö†Ô∏è"]})]},e.id))}),t.jsxs("div",{style:{padding:"1rem",borderTop:"1px solid #374151",display:"flex",gap:"0.5rem"},children:[t.jsx("input",{type:"text",value:a,onChange:e=>h(e.target.value),onKeyPress:e=>e.key==="Enter"&&y(),placeholder:"Scrie un mesaj...",disabled:c,style:{flex:1,padding:"0.75rem",borderRadius:"8px",border:"1px solid #374151",background:"#111827",color:"white",outline:"none"}}),t.jsx("button",{onClick:y,disabled:c||!a.trim(),style:{padding:"0.75rem 1.5rem",borderRadius:"8px",border:"none",background:c||!a.trim()?"#4b5563":"#3b82f6",color:"white",cursor:c||!a.trim()?"not-allowed":"pointer",fontWeight:"500"},children:c?"‚è≥":"üì§"})]})]}):t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#9ca3af"},children:"SelecteazƒÉ o conversa»õie"})})]}):t.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#ef4444"},children:"‚ùå Niciun cont WhatsApp conectat"})}export{J as C};
