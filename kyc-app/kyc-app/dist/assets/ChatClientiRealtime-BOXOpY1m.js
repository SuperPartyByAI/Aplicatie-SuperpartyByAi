import{d as f,j as e}from"./index-go8NIyy-.js";import{b as o}from"./react-vendor-BCFq-EBz.js";import{G as z,M as C,I as P,H as W,P as B,K as H,N as O,t as D,u as b,q as _}from"./firebase-CZFSqwcK.js";const K="https://whats-upp-production.up.railway.app";function X({isGMMode:p=!1,userCode:a=null}){const[d,E]=o.useState(null),[u,M]=o.useState([]),[y,j]=o.useState([]),[r,I]=o.useState(null),[$,x]=o.useState([]),[l,v]=o.useState(""),[N,w]=o.useState(!0),[g,S]=o.useState(!1),[m,h]=o.useState("all"),[k,T]=o.useState(null);o.useEffect(()=>{q()},[]),o.useEffect(()=>{if(!d)return;console.log(`ğŸ“¡ Setting up real-time listener for threads (accountId: ${d.id})...`);const t=z(W(f,"threads"),P("accountId","==",d.id),C(50)),i=B(t,n=>{const s=n.docs.map(c=>({id:c.id,...c.data()}));s.sort((c,L)=>{const J=c.lastMessageAt?.toMillis?.()||0;return(L.lastMessageAt?.toMillis?.()||0)-J}),console.log(`ğŸ“¥ Received ${s.length} threads (sorted client-side)`),M(s),w(!1),T(null)},n=>{console.error("âŒ Error listening to threads:",n),console.error("Error code:",n.code),console.error("Error message:",n.message);let s="Eroare la Ã®ncÄƒrcarea conversaÈ›iilor";n.code==="failed-precondition"||n.message.includes("index")?s="âš ï¸ Index Firestore lipsÄƒ. Se construieÈ™te automat (2-5 min). ReÃ®mprospÄƒteazÄƒ pagina.":n.code==="permission-denied"&&(s="âŒ Permisiuni insuficiente. ContacteazÄƒ administratorul."),T(s),w(!1)});return()=>i()},[d]),o.useEffect(()=>{if(!a){j(u);return}const t=a.charAt(0);let i=u;switch(m){case"my":i=u.filter(n=>n.assignedTo===a);break;case"team":i=u.filter(n=>n.assignedTo&&n.assignedTo.startsWith(t));break;case"unassigned":i=u.filter(n=>!n.assignedTo);break;default:i=u;break}j(i)},[u,m,a]),o.useEffect(()=>{if(!r)return;console.log(`ğŸ“¡ Setting up real-time listener for messages in thread ${r.id}...`);const t=z(W(f,"threads",r.id,"messages"),H("tsClient","asc"),C(100)),i=B(t,n=>{const s=n.docs.map(c=>({id:c.id,...c.data()}));console.log(`ğŸ“¥ Received ${s.length} messages for thread ${r.id}`),x(s)},n=>{console.error("âŒ Error listening to messages:",n)});return()=>i()},[r]);const q=async()=>{try{const i=await(await fetch(`${K}/api/whatsapp/accounts`)).json();if(i.accounts&&i.accounts.length>0){const n=i.accounts.find(s=>s.status==="connected");n?(E(n),console.log("âœ… Connected account:",n.id)):console.warn("âš ï¸ No connected WhatsApp account")}}catch(t){console.error("âŒ Failed to load accounts:",t)}},A=async()=>{if(!(!l.trim()||!r||!d)){if(!p&&r.assignedTo&&r.assignedTo!==a){alert(`âš ï¸ Nu poÈ›i scrie! Client alocat lui ${r.assignedTo}`);return}S(!0);try{const t=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;!r.assignedTo&&a&&!p&&(await O(D(f,"threads",r.id),{assignedTo:a,assignedAt:b()}),console.log(`âœ… Thread assigned to ${a}`));const i={accountId:d.id,toJid:r.clientJid,threadId:r.id,payload:{text:l},body:l,status:"queued",createdAt:b(),nextAttemptAt:b(),attemptCount:0,requestId:t};await _(D(f,"outbox",t),i),console.log("âœ… Message queued in outbox");const n={id:`temp_${Date.now()}`,accountId:d.id,clientJid:r.clientJid,direction:"outbound",body:l,status:"queued",tsClient:new Date().toISOString(),createdAt:{seconds:Date.now()/1e3}};x(s=>[...s,n]),v("")}catch(t){console.error("âŒ Failed to send message:",t),alert("âŒ Eroare la trimiterea mesajului")}finally{S(!1)}}},F=t=>{I(t),x([])},R=t=>{if(!t)return"";let i;if(t.seconds)i=new Date(t.seconds*1e3);else if(typeof t=="string")i=new Date(t);else return"";const s=new Date-i;return Math.floor(s/(1e3*60*60))<24?i.toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):i.toLocaleDateString("ro-RO",{day:"2-digit",month:"2-digit"})};return N?e.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#9ca3af"},children:"Se Ã®ncarcÄƒ conversaÈ›iile..."}):k?e.jsxs("div",{style:{padding:"2rem",textAlign:"center",maxWidth:"600px",margin:"0 auto"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"âš ï¸"}),e.jsx("h2",{style:{color:"#ef4444",marginBottom:"1rem"},children:"Eroare la Ã®ncÄƒrcarea conversaÈ›iilor"}),e.jsxs("div",{style:{background:"#1f2937",padding:"1.5rem",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("p",{style:{color:"#d1d5db",marginBottom:"1rem"},children:k}),e.jsx("p",{style:{color:"#9ca3af",fontSize:"0.875rem"},children:"VerificÄƒ consola browser-ului (F12) pentru detalii tehnice."})]}),e.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.75rem 1.5rem",background:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontWeight:"500"},children:"ğŸ”„ ReÃ®mprospÄƒteazÄƒ Pagina"})]}):d?e.jsxs("div",{style:{display:"flex",gap:"1rem",height:"600px",background:"#1f2937",borderRadius:"8px",overflow:"hidden"},children:[e.jsxs("div",{style:{width:"300px",borderRight:"1px solid #374151",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #374151"},children:[e.jsxs("div",{style:{fontWeight:"600",color:"white",marginBottom:"0.75rem"},children:["ğŸ’¬ ConversaÈ›ii (",y.length,")"]}),a&&e.jsxs("div",{style:{display:"flex",gap:"0.25rem",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>h("my"),style:{padding:"0.375rem 0.75rem",fontSize:"0.75rem",background:m==="my"?"#3b82f6":"#374151",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Ai mei"}),e.jsx("button",{onClick:()=>h("team"),style:{padding:"0.375rem 0.75rem",fontSize:"0.75rem",background:m==="team"?"#3b82f6":"#374151",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Echipa"}),p&&e.jsx("button",{onClick:()=>h("unassigned"),style:{padding:"0.375rem 0.75rem",fontSize:"0.75rem",background:m==="unassigned"?"#3b82f6":"#374151",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"NealocaÈ›i"}),e.jsx("button",{onClick:()=>h("all"),style:{padding:"0.375rem 0.75rem",fontSize:"0.75rem",background:m==="all"?"#3b82f6":"#374151",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"ToÈ›i"})]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto"},children:y.map(t=>e.jsxs("div",{onClick:()=>F(t),style:{padding:"1rem",borderBottom:"1px solid #374151",cursor:"pointer",background:r?.id===t.id?"#374151":"transparent",transition:"background 0.2s"},onMouseEnter:i=>{r?.id!==t.id&&(i.currentTarget.style.background="#2d3748")},onMouseLeave:i=>{r?.id!==t.id&&(i.currentTarget.style.background="transparent")},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.25rem"},children:[e.jsx("div",{style:{fontWeight:"500",color:"white"},children:t.clientJid?.split("@")[0]||"Unknown"}),t.assignedTo?e.jsx("div",{style:{fontSize:"0.625rem",padding:"0.125rem 0.375rem",background:"#10b981",borderRadius:"4px",color:"white"},children:t.assignedTo}):e.jsx("div",{style:{fontSize:"0.625rem",padding:"0.125rem 0.375rem",background:"#f59e0b",borderRadius:"4px",color:"white"},children:"Nealoctat"})]}),e.jsx("div",{style:{fontSize:"0.875rem",color:"#9ca3af",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.lastMessageBody||"No messages"}),e.jsx("div",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem"},children:R(t.lastMessageAt)})]},t.id))})]}),e.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"1rem",borderBottom:"1px solid #374151",fontWeight:"600",color:"white"},children:r.clientJid?.split("@")[0]||"Unknown"}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"1rem",display:"flex",flexDirection:"column",gap:"0.5rem"},children:$.filter(t=>{const i=t.body||"";return!(i.includes("[Admin]")||i.includes("[GM]"))}).map(t=>e.jsxs("div",{style:{alignSelf:t.direction==="outbound"?"flex-end":"flex-start",maxWidth:"70%"},children:[e.jsx("div",{style:{padding:"0.75rem",borderRadius:"8px",background:t.direction==="outbound"?"#3b82f6":"#374151",color:"white"},children:t.body}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem",textAlign:t.direction==="outbound"?"right":"left"},children:[R(t.tsClient||t.createdAt)," ",t.status==="queued"&&"â³",t.status==="sent"&&"âœ“",t.status==="delivered"&&"âœ“âœ“",t.status==="failed"&&"âš ï¸"]})]},t.id))}),p||!r.assignedTo||r.assignedTo===a?e.jsxs("div",{style:{padding:"1rem",borderTop:"1px solid #374151",display:"flex",gap:"0.5rem"},children:[e.jsx("input",{type:"text",value:l,onChange:t=>v(t.target.value),onKeyPress:t=>t.key==="Enter"&&A(),placeholder:r.assignedTo?"Scrie un mesaj...":"Scrie mesaj... (vei prelua clientul)",disabled:g,style:{flex:1,padding:"1rem 1.25rem",borderRadius:"8px",border:"1px solid #374151",background:"#111827",color:"white",outline:"none",fontSize:"1rem",minHeight:"48px"}}),e.jsx("button",{onClick:A,disabled:g||!l.trim(),style:{padding:"0.75rem 1rem",borderRadius:"8px",border:"none",background:g||!l.trim()?"#4b5563":"#3b82f6",color:"white",cursor:g||!l.trim()?"not-allowed":"pointer",fontWeight:"500",minHeight:"48px",minWidth:"60px"},children:g?"â³":"ğŸ“¤"})]}):e.jsxs("div",{style:{padding:"1rem",borderTop:"1px solid #374151",textAlign:"center",color:"#94a3b8",background:"#1f2937"},children:["ğŸ”’ Client alocat lui ",e.jsx("strong",{children:r.assignedTo}),". Doar vizualizare."]})]}):e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:"#9ca3af",padding:"2rem"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"ğŸ’¬"}),e.jsx("div",{style:{fontSize:"1.25rem",fontWeight:"600",marginBottom:"0.5rem",color:"white"},children:"SelecteazÄƒ o conversaÈ›ie"}),e.jsx("div",{style:{textAlign:"center",maxWidth:"400px"},children:"Click pe o conversaÈ›ie din lista din stÃ¢nga pentru a vedea mesajele È™i a putea rÄƒspunde."})]})})]}):e.jsxs("div",{style:{padding:"2rem",textAlign:"center",maxWidth:"600px",margin:"0 auto"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"ğŸ“±"}),e.jsx("h2",{style:{color:"#ef4444",marginBottom:"1rem"},children:"Niciun cont WhatsApp conectat"}),e.jsx("p",{style:{color:"#9ca3af",marginBottom:"1.5rem"},children:"Pentru a vedea conversaÈ›iile, trebuie sÄƒ conectezi un cont WhatsApp."}),e.jsxs("div",{style:{background:"#1f2937",padding:"1.5rem",borderRadius:"8px",textAlign:"left"},children:[e.jsx("h3",{style:{color:"#10b981",marginBottom:"1rem"},children:"ğŸ“‹ PaÈ™i pentru conectare:"}),e.jsxs("ol",{style:{color:"#d1d5db",lineHeight:"1.8"},children:[e.jsxs("li",{children:["Mergi la ",e.jsx("strong",{style:{color:"#60a5fa"},children:"/chat-clienti"})," sau ",e.jsx("strong",{style:{color:"#60a5fa"},children:"/accounts-management"})]}),e.jsxs("li",{children:["Click pe tab ",e.jsx("strong",{style:{color:"#60a5fa"},children:'"âš™ï¸ Accounts"'})]}),e.jsxs("li",{children:["Click pe ",e.jsx("strong",{style:{color:"#60a5fa"},children:'"â• Add Account"'})]}),e.jsxs("li",{children:["ScaneazÄƒ ",e.jsx("strong",{style:{color:"#60a5fa"},children:"QR code"})," cu WhatsApp pe telefon"]}),e.jsxs("li",{children:["AÈ™teaptÄƒ ca status sÄƒ devinÄƒ ",e.jsx("strong",{style:{color:"#10b981"},children:"ğŸŸ¢ connected"})]}),e.jsx("li",{children:"Revino aici pentru a vedea conversaÈ›iile"})]})]}),e.jsx("div",{style:{marginTop:"1.5rem"},children:e.jsx("a",{href:"/chat-clienti",style:{display:"inline-block",padding:"0.75rem 1.5rem",background:"#3b82f6",color:"white",borderRadius:"6px",textDecoration:"none",fontWeight:"500"},children:"ğŸ”— ConecteazÄƒ Cont WhatsApp"})})]})}export{X as C};
