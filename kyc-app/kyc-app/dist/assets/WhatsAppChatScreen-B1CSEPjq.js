import{a as Y,j as t,d as p}from"./index-CyyftA72.js";import{u as G,b as o}from"./react-vendor-BCFq-EBz.js";import{G as R,K as T,H as x,P as E,I as X,B as $,t as W,O as A,u as y,N as Q}from"./firebase-CZFSqwcK.js";function re(){const v=G(),b=Y.currentUser,[u,M]=o.useState(null),[w,N]=o.useState([]),[r,_]=o.useState(null),[B,L]=o.useState([]),[l,S]=o.useState(""),[F,j]=o.useState(!0),[g,D]=o.useState(!1),[f,P]=o.useState(""),[m,q]=o.useState(""),[h,O]=o.useState(""),[C,k]=o.useState([]),z=o.useRef(null);o.useEffect(()=>{if(!b){v("/");return}(async()=>{const i=await $(W(p,"staffProfiles",b.uid));i.exists()&&M(i.data())})();const n=R(x(p,"whatsapp_threads"),T("lastMessageTime","desc")),s=E(n,i=>{console.log("ðŸ’¬ Threads snapshot received:",i.size,"documents");const c=i.docs.map(a=>{const d=a.data();return!d||!d.lastMessageTime?null:{id:a.id,client_phone:d.phoneNumber||a.id,unread_count_for_operator:d.unreadCount||0,last_client_message_at:d.lastMessageTime,assigned_operator_code:d.assigned_operator_code||null,reserved_at:d.reserved_at||null,status:d.assigned_operator_code?"RESERVED":"AVAILABLE",name:d.name||d.phoneNumber||"Unknown"}}).filter(a=>a!==null&&a.status==="RESERVED");console.log("âœ… Reserved conversations:",c.length),N(c),k(c),j(!1)},i=>{console.error("âŒ Error listening to threads:",i),j(!1)});return()=>s()},[b,v]),o.useEffect(()=>{if(!r)return;const e=R(x(p,"whatsapp_messages"),X("threadId","==",r.id),T("timestamp","asc")),n=E(e,s=>{const i=s.docs.map(c=>{const a=c.data();return{id:c.id,conversation_id:r.id,sender_type:a.fromMe?"OPERATOR":"CLIENT",sender_operator_code:a.fromMe?u?.code:null,timestamp:a.timestamp,content:a.body||"",delivery_status:a.status||"sent",ai_auto_response:!1}});L(i),setTimeout(()=>{z.current?.scrollIntoView({behavior:"smooth"})},100)});return()=>n()},[r,u]),o.useEffect(()=>{let e=[...w];if(h.trim()&&(e=e.filter(n=>n.assigned_operator_code===h.trim())),f){const n=new Date(f);n.setHours(0,0,0,0),e=e.filter(s=>(s.reserved_at?.toDate?s.reserved_at.toDate():new Date(s.reserved_at))>=n)}if(m){const n=new Date(m);n.setHours(23,59,59,999),e=e.filter(s=>(s.reserved_at?.toDate?s.reserved_at.toDate():new Date(s.reserved_at))<=n)}k(e)},[h,f,m,w]);const I=async()=>{if(!(!l.trim()||!r||!u?.code)){if(r.assigned_operator_code!==u.code){alert("Doar operatorul rezervant poate rÄƒspunde");return}D(!0);try{const e=`msg_${Date.now()}`;await A(x(p,"outbox"),{accountId:"account_1767042206934",toJid:r.client_phone,payload:{text:l.trim()},status:"queued",createdAt:y(),attempts:0}),await A(x(p,"threads",r.id,"messages"),{accountId:"operator",clientJid:r.client_phone,direction:"outbound",body:l.trim(),timestamp:y(),status:"queued",providerMessageId:e}),await Q(W(p,"threads",r.id),{lastMessageAt:y(),lastMessageBody:l.trim()}),S("")}catch(e){console.error("Error sending message:",e),alert("Eroare la trimitere mesaj: "+e.message)}finally{D(!1)}}},H=async()=>{r&&alert("FuncÈ›ie AI - NoteazÄƒ date esenÈ›iale petrecere (Data, Ora, Adresa, Rol)")},V=async()=>{r&&alert("FuncÈ›ie - Istoric complet (WhatsApp + Telefon) Ã®n timeline cronologic")},K=async()=>{r&&alert("FuncÈ›ie - Transcriere audio Telefon")},U=e=>e?(e.toDate?e.toDate():new Date(e)).toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):"",J=r&&u?.code===r.assigned_operator_code;return t.jsxs("div",{style:{height:"100vh",display:"flex",flexDirection:"column",background:"#0a0e27",overflow:"hidden"},children:[t.jsxs("div",{style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",padding:"1rem",color:"white",boxShadow:"0 2px 10px rgba(0,0,0,0.3)"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[t.jsx("span",{style:{fontSize:"1.5rem"},children:"ðŸ’¬"}),t.jsx("h1",{style:{margin:0,fontSize:"1.3rem",fontWeight:"600"},children:"Chat ClienÈ›i"})]}),t.jsxs("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",fontSize:"0.85rem"},children:[t.jsx("input",{type:"date",value:f,onChange:e=>P(e.target.value),style:{padding:"0.4rem",borderRadius:"20px",border:"none",background:"rgba(255,255,255,0.2)",color:"white",fontSize:"0.85rem"}}),t.jsx("input",{type:"date",value:m,onChange:e=>q(e.target.value),style:{padding:"0.4rem",borderRadius:"20px",border:"none",background:"rgba(255,255,255,0.2)",color:"white",fontSize:"0.85rem"}}),t.jsx("input",{type:"text",value:h,onChange:e=>O(e.target.value),placeholder:"Cod operator",style:{padding:"0.4rem 0.8rem",borderRadius:"20px",border:"none",background:"rgba(255,255,255,0.2)",color:"white",fontSize:"0.85rem",flex:1,minWidth:"120px"}})]})]}),F?t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"white"},children:t.jsx("div",{className:"spinner"})}):t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:window.innerWidth<768?"column":"row",overflow:"hidden"},children:[t.jsx("div",{style:{width:window.innerWidth<768?"100%":"320px",height:window.innerWidth<768&&r?"0":"auto",display:window.innerWidth<768&&r?"none":"block",overflowY:"auto",background:"#151b3d",borderRight:window.innerWidth>=768?"1px solid rgba(255,255,255,0.1)":"none"},children:C.length===0?t.jsx("p",{style:{color:"#888",textAlign:"center",padding:"2rem"},children:"Nu existÄƒ conversaÈ›ii"}):C.map(e=>t.jsxs("div",{onClick:()=>_(e),style:{padding:"1rem",background:r?.id===e.id?"linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%)":"transparent",borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"all 0.2s",":hover":{background:"rgba(255,255,255,0.05)"}},onMouseEnter:n=>{r?.id!==e.id&&(n.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:n=>{r?.id!==e.id&&(n.currentTarget.style.background="transparent")},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.3rem"},children:[t.jsx("span",{style:{fontSize:"1.2rem"},children:"ðŸ“±"}),t.jsx("span",{style:{fontWeight:"600",color:"white",fontSize:"0.95rem"},children:e.client_phone}),e.unread_count_for_operator>0&&t.jsx("span",{style:{background:"#4CAF50",color:"white",padding:"0.1rem 0.5rem",borderRadius:"12px",fontSize:"0.75rem",fontWeight:"bold"},children:e.unread_count_for_operator})]}),t.jsx("div",{style:{fontSize:"0.8rem",color:"#888",marginLeft:"1.7rem"},children:e.assigned_operator_code})]},e.id))}),r&&t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",background:"#0a0e27",position:"relative"},children:[t.jsxs("div",{style:{padding:"1rem",background:"#151b3d",borderBottom:"1px solid rgba(255,255,255,0.1)",display:"flex",alignItems:"center",gap:"0.5rem"},children:[window.innerWidth<768&&t.jsx("button",{onClick:()=>_(null),style:{background:"transparent",border:"none",color:"white",fontSize:"1.5rem",cursor:"pointer",padding:"0",marginRight:"0.5rem"},children:"â†"}),t.jsxs("div",{style:{flex:1},children:[t.jsxs("div",{style:{fontWeight:"600",color:"white",fontSize:"1rem"},children:["ðŸ“± ",r.client_phone]}),t.jsx("div",{style:{fontSize:"0.75rem",color:"#888"},children:r.assigned_operator_code})]})]}),t.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"1rem",background:"linear-gradient(180deg, #0a0e27 0%, #151b3d 100%)"},children:[B.map(e=>t.jsx("div",{style:{marginBottom:"1rem",display:"flex",justifyContent:e.sender_type==="CLIENT"?"flex-start":"flex-end"},children:t.jsxs("div",{style:{maxWidth:"75%",padding:"0.75rem 1rem",borderRadius:e.sender_type==="CLIENT"?"18px 18px 18px 4px":"18px 18px 4px 18px",background:e.sender_type==="CLIENT"?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":e.sender_type==="AI"?"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)":"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",color:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"},children:[t.jsxs("div",{style:{fontSize:"0.7rem",opacity:.8,marginBottom:"0.3rem"},children:[e.sender_type," â€¢ ",U(e.timestamp)]}),t.jsx("div",{style:{fontSize:"0.95rem",lineHeight:"1.4"},children:e.content})]})},e.id)),t.jsx("div",{ref:z})]}),t.jsxs("div",{style:{padding:"0.75rem",background:"#151b3d",borderTop:"1px solid rgba(255,255,255,0.1)",display:"flex",gap:"0.5rem",overflowX:"auto",flexWrap:"nowrap"},children:[t.jsx("button",{onClick:H,style:{padding:"0.6rem 1rem",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",color:"white",border:"none",borderRadius:"20px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"600",whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(102, 126, 234, 0.3)"},children:"ðŸ¤– Date petrecere"}),t.jsx("button",{onClick:V,style:{padding:"0.6rem 1rem",background:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",color:"white",border:"none",borderRadius:"20px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"600",whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(240, 147, 251, 0.3)"},children:"ðŸ“œ Istoric"}),t.jsx("button",{onClick:K,style:{padding:"0.6rem 1rem",background:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",color:"white",border:"none",borderRadius:"20px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"600",whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(79, 172, 254, 0.3)"},children:"ðŸŽ¤ Transcriere"})]}),t.jsx("div",{style:{padding:"1rem",background:"#151b3d",borderTop:"1px solid rgba(255,255,255,0.1)"},children:J?t.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[t.jsx("input",{type:"text",value:l,onChange:e=>S(e.target.value),onKeyPress:e=>e.key==="Enter"&&!e.shiftKey&&I(),placeholder:"Scrie mesaj...",disabled:g,style:{flex:1,padding:"0.75rem 1rem",borderRadius:"25px",border:"none",background:"rgba(255,255,255,0.1)",color:"white",fontSize:"0.95rem",outline:"none"}}),t.jsx("button",{onClick:I,disabled:g||!l.trim(),style:{width:"50px",height:"50px",borderRadius:"50%",background:l.trim()?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"rgba(255,255,255,0.1)",color:"white",border:"none",cursor:g||!l.trim()?"not-allowed":"pointer",fontSize:"1.3rem",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:l.trim()?"0 2px 8px rgba(102, 126, 234, 0.4)":"none",transition:"all 0.2s"},children:g?"â³":"ðŸ“¤"})]}):t.jsx("div",{style:{textAlign:"center",color:"#888",padding:"0.5rem",fontSize:"0.9rem"},children:"ðŸ”’ Doar operatorul rezervant poate rÄƒspunde"})})]}),!r&&window.innerWidth>=768&&t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#888",fontSize:"1.1rem"},children:t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"ðŸ’¬"}),t.jsx("div",{children:"SelecteazÄƒ o conversaÈ›ie"})]})})]})]})}export{re as default};
