import{j as t,a as _}from"./index-BxCQG0pv.js";import{u as U,b as r}from"./react-vendor-BCFq-EBz.js";import{l as L}from"./index-CG1tBJBN.js";import{Device as O}from"@twilio/voice-sdk";import"./firebase-CZFSqwcK.js";const u="https://web-production-f0714.up.railway.app";function X(){const S=U(),[f,z]=r.useState(null),[b,m]=r.useState([]),[d,h]=r.useState(null),[a,C]=r.useState(null),[k,R]=r.useState([]),[V,I]=r.useState(null),[l,p]=r.useState(null),[W,x]=r.useState(!1),[T,g]=r.useState(null),j=r.useRef(null),y=r.useRef(null);r.useEffect(()=>(A(),()=>{j.current&&j.current.destroy()}),[]);const A=async()=>{try{const i=await(await fetch(`${u}/api/voice/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({identity:"operator"})})).json();if(!i.success){console.error("Failed to get Twilio token:",i.error);return}const n=new O(i.token,{logLevel:1,codecPreferences:["opus","pcmu"]});n.on("registered",()=>{console.log("âœ… Twilio Device registered")}),n.on("error",s=>{console.error("âŒ Twilio Device error:",s)}),n.on("incoming",s=>{console.log("ðŸ“ž Incoming Twilio call"),p(s),s.on("accept",()=>{console.log("âœ… Call accepted"),x(!1)}),s.on("disconnect",()=>{console.log("âœ• Call disconnected"),p(null),x(!1)}),s.on("reject",()=>{console.log("âœ• Call rejected"),p(null),x(!1)})}),await n.register(),I(n),j.current=n,console.log("âœ… Twilio Device initialized")}catch(e){console.error("âŒ Error initializing Twilio Device:",e)}};r.useEffect(()=>{const e=L(u);return z(e),e.on("connect",()=>{console.log("âœ… Connected to Voice backend")}),e.on("disconnect",()=>{console.log("âŒ Disconnected from Voice backend")}),e.on("call:incoming",o=>{console.log("ðŸ“ž Incoming call:",o),h(o),m(i=>[...i,o])}),e.on("call:status",o=>{console.log("ðŸ“Š Call status update:",o),m(i=>i.map(n=>n.callId===o.callId?o:n))}),e.on("call:ended",o=>{console.log("âœ• Call ended:",o),m(i=>i.filter(n=>n.callId!==o.callId)),d?.callId===o.callId&&h(null),c(),setTimeout(()=>{c()},15e3),setTimeout(()=>{c()},3e4),setTimeout(()=>{c(),w()},6e4)}),()=>{e.disconnect()}},[]),r.useEffect(()=>{w(),c();const e=setInterval(()=>{c(),w()},3e4);return()=>clearInterval(e)},[]);const w=async()=>{try{const o=await(await fetch(`${u}/api/voice/calls/stats`)).json();o.success&&C(o.stats)}catch(e){console.error("Error fetching call stats:",e)}},c=async()=>{try{const o=await(await fetch(`${u}/api/voice/calls/recent?limit=20`)).json();o.success&&R(o.calls)}catch(e){console.error("Error fetching recent calls:",e)}},B=async e=>{if(!l){console.error("No active connection to answer");return}try{x(!0),l.accept(),f&&f.emit("call:answer",{callId:e,operatorId:_.currentUser?.uid||"unknown"}),h(null),console.log("âœ… Call answered with audio")}catch(o){console.error("âŒ Error answering call:",o),x(!1)}},E=e=>{l&&l.reject(),f&&f.emit("call:reject",{callId:e,reason:"rejected_by_operator"}),h(null),p(null)},D=()=>{l&&(l.disconnect(),p(null))},N=async(e,o)=>{try{g(o||e);const i=`${u}/api/voice/calls/${e}/recording/audio`;console.log("Playing recording from:",i);const n=new Audio;y.current=n,n.src=i,n.onended=()=>{g(null)},n.onerror=s=>{console.error("Audio playback error:",s),alert("Eroare la redarea Ã®nregistrÄƒrii. VerificÄƒ cÄƒ Ã®nregistrarea este disponibilÄƒ."),g(null)},await n.play()}catch(i){console.error("Error playing recording:",i),alert("Eroare la redarea Ã®nregistrÄƒrii"),g(null)}},$=()=>{y.current&&(y.current.pause(),y.current=null),g(null)},v=e=>{if(!e)return"0:00";const o=Math.floor(e/60),i=e%60;return`${o}:${String(i).padStart(2,"0")}`},P=e=>{if(!e)return"-";try{let o;if(typeof e=="object"&&e._seconds)o=new Date(e._seconds*1e3);else if(typeof e=="string"||typeof e=="number")o=new Date(e);else return console.error("Unknown date format:",e),"-";return isNaN(o.getTime())?(console.error("Invalid date:",e),"-"):o.toLocaleString("ro-RO",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(o){return console.error("Error formatting date:",o,e),"-"}};return t.jsx("div",{style:{minHeight:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",padding:"20px"},children:t.jsxs("div",{style:{maxWidth:"1400px",margin:"0 auto"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"20px",marginBottom:"30px"},children:[t.jsx("button",{onClick:()=>S("/home"),style:{background:"rgba(255, 255, 255, 0.2)",border:"none",borderRadius:"12px",padding:"12px 16px",color:"white",fontSize:"20px",cursor:"pointer",transition:"all 0.3s"},children:"â†"}),t.jsx("h1",{style:{color:"white",fontSize:"32px",fontWeight:"800",margin:0},children:"ðŸ“ž CentralÄƒ TelefonicÄƒ"})]}),l&&!d&&t.jsxs("div",{style:{position:"fixed",bottom:"20px",right:"20px",background:"white",borderRadius:"15px",padding:"20px",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)",zIndex:9999,minWidth:"300px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"15px",marginBottom:"15px"},children:[t.jsx("div",{style:{width:"50px",height:"50px",borderRadius:"50%",background:"linear-gradient(135deg, #11998e 0%, #38ef7d 100%)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"24px",animation:"pulse 2s ease-in-out infinite"},children:"ðŸ“ž"}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:"700",fontSize:"16px",color:"#333"},children:"Apel Ã®n curs"}),t.jsx("div",{style:{fontSize:"14px",color:"#666",marginTop:"3px"},children:W?"Conectare...":"Conectat"})]})]}),t.jsx("button",{onClick:D,style:{width:"100%",padding:"12px",borderRadius:"10px",border:"none",background:"linear-gradient(135deg, #eb3349 0%, #f45c43 100%)",color:"white",fontSize:"16px",fontWeight:"600",cursor:"pointer",boxShadow:"0 4px 15px rgba(235, 51, 73, 0.3)"},children:"ðŸ”´ ÃŽnchide Apelul"})]}),d&&t.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4},children:t.jsxs("div",{style:{background:"white",borderRadius:"20px",padding:"40px",maxWidth:"400px",width:"90%",textAlign:"center",boxShadow:"0 20px 60px rgba(0, 0, 0, 0.3)"},children:[t.jsx("div",{style:{width:"100px",height:"100px",borderRadius:"50%",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",margin:"0 auto 20px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"48px",animation:"pulse 2s ease-in-out infinite"},children:"ðŸ“ž"}),t.jsx("h2",{style:{fontSize:"24px",marginBottom:"10px",color:"#333"},children:"Apel Incoming"}),t.jsx("p",{style:{fontSize:"18px",color:"#666",marginBottom:"20px"},children:d.from}),t.jsxs("div",{style:{display:"flex",gap:"20px",justifyContent:"center",marginTop:"30px"},children:[t.jsx("button",{onClick:()=>B(d.callId),style:{width:"70px",height:"70px",borderRadius:"50%",border:"none",background:"linear-gradient(135deg, #11998e 0%, #38ef7d 100%)",color:"white",fontSize:"28px",cursor:"pointer",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.2)"},children:"âœ“"}),t.jsx("button",{onClick:()=>E(d.callId),style:{width:"70px",height:"70px",borderRadius:"50%",border:"none",background:"linear-gradient(135deg, #eb3349 0%, #f45c43 100%)",color:"white",fontSize:"28px",cursor:"pointer",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.2)"},children:"âœ•"})]})]})}),a&&t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"20px",marginBottom:"30px"},children:[t.jsxs("div",{style:{background:"white",borderRadius:"15px",padding:"20px",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.1)"},children:[t.jsx("div",{style:{fontSize:"14px",color:"#666",marginBottom:"8px"},children:"Total Apeluri"}),t.jsx("div",{style:{fontSize:"32px",fontWeight:"700",color:"#667eea"},children:a.total})]}),t.jsxs("div",{style:{background:"white",borderRadius:"15px",padding:"20px",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.1)"},children:[t.jsx("div",{style:{fontSize:"14px",color:"#666",marginBottom:"8px"},children:"RÄƒspunse"}),t.jsx("div",{style:{fontSize:"32px",fontWeight:"700",color:"#10b981"},children:a.answered})]}),t.jsxs("div",{style:{background:"white",borderRadius:"15px",padding:"20px",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.1)"},children:[t.jsx("div",{style:{fontSize:"14px",color:"#666",marginBottom:"8px"},children:"Pierdute"}),t.jsx("div",{style:{fontSize:"32px",fontWeight:"700",color:"#ef4444"},children:a.missed})]}),t.jsxs("div",{style:{background:"white",borderRadius:"15px",padding:"20px",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.1)"},children:[t.jsx("div",{style:{fontSize:"14px",color:"#666",marginBottom:"8px"},children:"Durata Medie"}),t.jsx("div",{style:{fontSize:"32px",fontWeight:"700",color:"#f59e0b"},children:v(a.avgDuration)})]})]}),b.length>0&&t.jsxs("div",{style:{background:"white",borderRadius:"15px",padding:"20px",marginBottom:"30px",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.1)"},children:[t.jsxs("h3",{style:{fontSize:"18px",fontWeight:"700",marginBottom:"15px",color:"#333"},children:["ðŸ“ž Apeluri Active (",b.length,")"]}),b.map(e=>t.jsxs("div",{style:{padding:"15px",borderBottom:"1px solid #f0f0f0",display:"flex",alignItems:"center",gap:"15px"},children:[t.jsx("div",{style:{width:"45px",height:"45px",borderRadius:"50%",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"20px"},children:"ðŸ“ž"}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:"600",color:"#333",fontSize:"14px"},children:e.from}),t.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"3px"},children:e.status})]}),t.jsx("div",{style:{fontSize:"11px",padding:"3px 8px",borderRadius:"10px",background:e.status==="in-progress"?"#e8f5e9":"#fff3e0",color:e.status==="in-progress"?"#388e3c":"#f57c00",fontWeight:"500"},children:e.status==="in-progress"?"ðŸ“ž ÃŽn curs":"ðŸ”” SunÄƒ"})]},e.callId))]}),t.jsxs("div",{style:{background:"white",borderRadius:"15px",padding:"20px",boxShadow:"0 4px 15px rgba(0, 0, 0, 0.1)"},children:[t.jsx("h3",{style:{fontSize:"18px",fontWeight:"700",marginBottom:"15px",color:"#333"},children:"ðŸ“‹ Istoric Apeluri"}),t.jsx("div",{style:{overflowX:"auto"},children:t.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[t.jsx("thead",{children:t.jsxs("tr",{style:{borderBottom:"2px solid #f0f0f0"},children:[t.jsx("th",{style:{padding:"12px",textAlign:"left",fontSize:"12px",color:"#666",fontWeight:"600"},children:"Data"}),t.jsx("th",{style:{padding:"12px",textAlign:"left",fontSize:"12px",color:"#666",fontWeight:"600"},children:"NumÄƒr"}),t.jsx("th",{style:{padding:"12px",textAlign:"left",fontSize:"12px",color:"#666",fontWeight:"600"},children:"Durata"}),t.jsx("th",{style:{padding:"12px",textAlign:"left",fontSize:"12px",color:"#666",fontWeight:"600"},children:"Status"}),t.jsx("th",{style:{padding:"12px",textAlign:"left",fontSize:"12px",color:"#666",fontWeight:"600"},children:"ÃŽnregistrare"})]})}),t.jsx("tbody",{children:k.map(e=>t.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[t.jsx("td",{style:{padding:"12px",fontSize:"14px",color:"#333"},children:P(e.createdAt)}),t.jsx("td",{style:{padding:"12px",fontSize:"14px",color:"#333"},children:e.from}),t.jsx("td",{style:{padding:"12px",fontSize:"14px",color:"#333"},children:v(e.duration)}),t.jsx("td",{style:{padding:"12px"},children:t.jsx("span",{style:{fontSize:"12px",padding:"4px 8px",borderRadius:"10px",background:e.status==="completed"?"#e8f5e9":"#fee2e2",color:e.status==="completed"?"#388e3c":"#dc2626",fontWeight:"500"},children:e.status==="completed"?"âœ“ Finalizat":"âœ• "+e.status})}),t.jsx("td",{style:{padding:"12px"},children:e.recordingSid?T===(e.id||e.callId)?t.jsx("button",{onClick:$,style:{padding:"6px 12px",borderRadius:"8px",border:"none",background:"#ef4444",color:"white",fontSize:"12px",cursor:"pointer",fontWeight:"500"},children:"â¸ Stop"}):t.jsx("button",{onClick:()=>N(e.callId,e.id||e.callId),style:{padding:"6px 12px",borderRadius:"8px",border:"none",background:"#667eea",color:"white",fontSize:"12px",cursor:"pointer",fontWeight:"500"},children:"â–¶ AscultÄƒ"}):t.jsx("span",{style:{fontSize:"12px",color:"#999"},children:"-"})})]},e.id||e.callId))})]})})]})]})})}export{X as default};
