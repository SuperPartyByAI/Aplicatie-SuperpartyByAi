import{d as h,j as t}from"./index-CNFpyD2O.js";import{b as i}from"./react-vendor-BCFq-EBz.js";import{G as b,M as j,K as v,I as W,H as w,P as S,u as B,q as E,t as $}from"./firebase-CZFSqwcK.js";const q="https://whats-upp-production.up.railway.app";function J(){const[a,A]=i.useState(null),[p,C]=i.useState([]),[n,k]=i.useState(null),[R,u]=i.useState([]),[d,g]=i.useState(""),[D,f]=i.useState(!0),[c,x]=i.useState(!1);i.useEffect(()=>{M()},[]),i.useEffect(()=>{if(!a)return;console.log(`ğŸ“¡ Setting up real-time listener for threads (accountId: ${a.id})...`);const e=b(w(h,"threads"),W("accountId","==",a.id),v("lastMessageAt","desc"),j(50)),s=S(e,o=>{const r=o.docs.map(l=>({id:l.id,...l.data()}));console.log(`ğŸ“¥ Received ${r.length} threads`),C(r),f(!1)},o=>{console.error("âŒ Error listening to threads:",o),f(!1)});return()=>s()},[a]),i.useEffect(()=>{if(!n)return;console.log(`ğŸ“¡ Setting up real-time listener for messages in thread ${n.id}...`);const e=b(w(h,"threads",n.id,"messages"),v("tsClient","asc"),j(100)),s=S(e,o=>{const r=o.docs.map(l=>({id:l.id,...l.data()}));console.log(`ğŸ“¥ Received ${r.length} messages for thread ${n.id}`),u(r)},o=>{console.error("âŒ Error listening to messages:",o)});return()=>s()},[n]);const M=async()=>{try{const s=await(await fetch(`${q}/api/whatsapp/accounts`)).json();if(s.accounts&&s.accounts.length>0){const o=s.accounts.find(r=>r.status==="connected");o?(A(o),console.log("âœ… Connected account:",o.id)):console.warn("âš ï¸ No connected WhatsApp account")}}catch(e){console.error("âŒ Failed to load accounts:",e)}},m=async()=>{if(!(!d.trim()||!n||!a)){x(!0);try{const e=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={accountId:a.id,toJid:n.clientJid,payload:{text:d},body:d,status:"queued",createdAt:B(),attempts:0,requestId:e};await E($(h,"outbox",e),s),console.log("âœ… Message queued in outbox");const o={id:`temp_${Date.now()}`,accountId:a.id,clientJid:n.clientJid,direction:"outbound",body:d,status:"queued",tsClient:new Date().toISOString(),createdAt:{seconds:Date.now()/1e3}};u(r=>[...r,o]),g("")}catch(e){console.error("âŒ Failed to send message:",e),alert("âŒ Eroare la trimiterea mesajului")}finally{x(!1)}}},T=e=>{k(e),u([])},y=e=>{if(!e)return"";let s;if(e.seconds)s=new Date(e.seconds*1e3);else if(typeof e=="string")s=new Date(e);else return"";const r=new Date-s;return Math.floor(r/(1e3*60*60))<24?s.toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("ro-RO",{day:"2-digit",month:"2-digit"})};return D?t.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#9ca3af"},children:"Se Ã®ncarcÄƒ conversaÈ›iile..."}):a?t.jsxs("div",{style:{display:"flex",gap:"1rem",height:"600px",background:"#1f2937",borderRadius:"8px",overflow:"hidden"},children:[t.jsxs("div",{style:{width:"300px",borderRight:"1px solid #374151",display:"flex",flexDirection:"column"},children:[t.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #374151",fontWeight:"600",color:"white"},children:["ğŸ’¬ ConversaÈ›ii (",p.length,")"]}),t.jsx("div",{style:{flex:1,overflowY:"auto"},children:p.map(e=>t.jsxs("div",{onClick:()=>T(e),style:{padding:"1rem",borderBottom:"1px solid #374151",cursor:"pointer",background:n?.id===e.id?"#374151":"transparent",transition:"background 0.2s"},onMouseEnter:s=>{n?.id!==e.id&&(s.currentTarget.style.background="#2d3748")},onMouseLeave:s=>{n?.id!==e.id&&(s.currentTarget.style.background="transparent")},children:[t.jsx("div",{style:{fontWeight:"500",color:"white",marginBottom:"0.25rem"},children:e.clientJid?.split("@")[0]||"Unknown"}),t.jsx("div",{style:{fontSize:"0.875rem",color:"#9ca3af",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.lastMessageBody||"No messages"}),t.jsx("div",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem"},children:y(e.lastMessageAt)})]},e.id))})]}),t.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:n?t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{padding:"1rem",borderBottom:"1px solid #374151",fontWeight:"600",color:"white"},children:n.clientJid?.split("@")[0]||"Unknown"}),t.jsx("div",{style:{flex:1,overflowY:"auto",padding:"1rem",display:"flex",flexDirection:"column",gap:"0.5rem"},children:R.map(e=>t.jsxs("div",{style:{alignSelf:e.direction==="outbound"?"flex-end":"flex-start",maxWidth:"70%"},children:[t.jsx("div",{style:{padding:"0.75rem",borderRadius:"8px",background:e.direction==="outbound"?"#3b82f6":"#374151",color:"white"},children:e.body}),t.jsxs("div",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem",textAlign:e.direction==="outbound"?"right":"left"},children:[y(e.tsClient||e.createdAt)," ",e.status==="queued"&&"â³",e.status==="sent"&&"âœ“",e.status==="delivered"&&"âœ“âœ“",e.status==="failed"&&"âš ï¸"]})]},e.id))}),t.jsxs("div",{style:{padding:"1rem",borderTop:"1px solid #374151",display:"flex",gap:"0.5rem"},children:[t.jsx("input",{type:"text",value:d,onChange:e=>g(e.target.value),onKeyPress:e=>e.key==="Enter"&&m(),placeholder:"Scrie un mesaj...",disabled:c,style:{flex:1,padding:"0.75rem",borderRadius:"8px",border:"1px solid #374151",background:"#111827",color:"white",outline:"none"}}),t.jsx("button",{onClick:m,disabled:c||!d.trim(),style:{padding:"0.75rem 1.5rem",borderRadius:"8px",border:"none",background:c||!d.trim()?"#4b5563":"#3b82f6",color:"white",cursor:c||!d.trim()?"not-allowed":"pointer",fontWeight:"500"},children:c?"â³":"ğŸ“¤"})]})]}):t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#9ca3af"},children:"SelecteazÄƒ o conversaÈ›ie"})})]}):t.jsxs("div",{style:{padding:"2rem",textAlign:"center",maxWidth:"600px",margin:"0 auto"},children:[t.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"ğŸ“±"}),t.jsx("h2",{style:{color:"#ef4444",marginBottom:"1rem"},children:"Niciun cont WhatsApp conectat"}),t.jsx("p",{style:{color:"#9ca3af",marginBottom:"1.5rem"},children:"Pentru a vedea conversaÈ›iile, trebuie sÄƒ conectezi un cont WhatsApp."}),t.jsxs("div",{style:{background:"#1f2937",padding:"1.5rem",borderRadius:"8px",textAlign:"left"},children:[t.jsx("h3",{style:{color:"#10b981",marginBottom:"1rem"},children:"ğŸ“‹ PaÈ™i pentru conectare:"}),t.jsxs("ol",{style:{color:"#d1d5db",lineHeight:"1.8"},children:[t.jsxs("li",{children:["Mergi la ",t.jsx("strong",{style:{color:"#60a5fa"},children:"/chat-clienti"})," sau ",t.jsx("strong",{style:{color:"#60a5fa"},children:"/accounts-management"})]}),t.jsxs("li",{children:["Click pe tab ",t.jsx("strong",{style:{color:"#60a5fa"},children:'"âš™ï¸ Accounts"'})]}),t.jsxs("li",{children:["Click pe ",t.jsx("strong",{style:{color:"#60a5fa"},children:'"â• Add Account"'})]}),t.jsxs("li",{children:["ScaneazÄƒ ",t.jsx("strong",{style:{color:"#60a5fa"},children:"QR code"})," cu WhatsApp pe telefon"]}),t.jsxs("li",{children:["AÈ™teaptÄƒ ca status sÄƒ devinÄƒ ",t.jsx("strong",{style:{color:"#10b981"},children:"ğŸŸ¢ connected"})]}),t.jsx("li",{children:"Revino aici pentru a vedea conversaÈ›iile"})]})]}),t.jsx("div",{style:{marginTop:"1.5rem"},children:t.jsx("a",{href:"/chat-clienti",style:{display:"inline-block",padding:"0.75rem 1.5rem",background:"#3b82f6",color:"white",borderRadius:"6px",textDecoration:"none",fontWeight:"500"},children:"ğŸ”— ConecteazÄƒ Cont WhatsApp"})})]})}export{J as C};
