import{a as J,d as u,j as t}from"./index-CvBWZv1w.js";import{u as U,b as o}from"./react-vendor-BCFq-EBz.js";import{G as z,H as b,P as R,K as Y,B as G,t as I,O as X,u as E}from"./firebase-CZFSqwcK.js";function ee(){const y=U(),h=J.currentUser,[c,W]=o.useState(null),[v,T]=o.useState([]),[r,w]=o.useState(null),[A,B]=o.useState([]),[s,S]=o.useState(""),[L,M]=o.useState(!0),[g,j]=o.useState(!1),[f,N]=o.useState(""),[m,F]=o.useState(""),[x,P]=o.useState(""),[_,D]=o.useState([]),C=o.useRef(null);o.useEffect(()=>{if(!h){y("/");return}(async()=>{const d=await G(I(u,"staffProfiles",h.uid));d.exists()&&W(d.data())})();const n=z(b(u,"threads")),a=R(n,d=>{const p=d.docs.map(i=>{const l=i.data();return{id:i.id,client_phone:l.clientJid||i.id,unread_count_for_operator:l.unreadCount||0,last_client_message_at:l.lastMessageAt||l.createdAt,assigned_operator_code:l.assigned_operator_code||null,reserved_at:l.reserved_at||null,status:l.assigned_operator_code?"RESERVED":"AVAILABLE"}}).filter(i=>i.status==="RESERVED");T(p),D(p),M(!1)});return()=>a()},[h,y]),o.useEffect(()=>{if(!r)return;const e=z(b(u,"threads",r.id,"messages"),Y("timestamp","asc")),n=R(e,a=>{const d=a.docs.map(p=>{const i=p.data();return{id:p.id,conversation_id:r.id,sender_type:i.direction==="inbound"?"CLIENT":"OPERATOR",sender_operator_code:i.direction==="outbound"?c?.code:null,timestamp:i.timestamp,content:i.body||"",delivery_status:i.status,ai_auto_response:!1}});B(d),setTimeout(()=>{C.current?.scrollIntoView({behavior:"smooth"})},100)});return()=>n()},[r,c]),o.useEffect(()=>{let e=[...v];if(x.trim()&&(e=e.filter(n=>n.assigned_operator_code===x.trim())),f){const n=new Date(f);n.setHours(0,0,0,0),e=e.filter(a=>(a.reserved_at?.toDate?a.reserved_at.toDate():new Date(a.reserved_at))>=n)}if(m){const n=new Date(m);n.setHours(23,59,59,999),e=e.filter(a=>(a.reserved_at?.toDate?a.reserved_at.toDate():new Date(a.reserved_at))<=n)}D(e)},[x,f,m,v]);const k=async()=>{if(!(!s.trim()||!r||!c?.code)){if(r.assigned_operator_code!==c.code){alert("Doar operatorul rezervant poate rÄƒspunde");return}j(!0);try{const e=`msg_${Date.now()}`;await X(b(u,"threads",r.id,"messages"),{accountId:"operator",clientJid:r.client_phone,direction:"outbound",body:s.trim(),timestamp:E(),status:"sent",providerMessageId:e}),await updateDoc(I(u,"threads",r.id),{lastMessageAt:E(),lastMessageBody:s.trim()}),S("")}catch(e){console.error("Error sending message:",e),alert("Eroare la trimitere mesaj")}finally{j(!1)}}},O=async()=>{r&&alert("FuncÈ›ie AI - NoteazÄƒ date esenÈ›iale petrecere (Data, Ora, Adresa, Rol)")},H=async()=>{r&&alert("FuncÈ›ie - Istoric complet (WhatsApp + Telefon) Ã®n timeline cronologic")},V=async()=>{r&&alert("FuncÈ›ie - Transcriere audio Telefon")},q=e=>e?(e.toDate?e.toDate():new Date(e)).toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):"",K=r&&c?.code===r.assigned_operator_code;return t.jsxs("div",{style:{height:"100vh",display:"flex",flexDirection:"column",background:"#0a0e27",overflow:"hidden"},children:[t.jsxs("div",{style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",padding:"1rem",color:"white",boxShadow:"0 2px 10px rgba(0,0,0,0.3)"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[t.jsx("span",{style:{fontSize:"1.5rem"},children:"ðŸ’¬"}),t.jsx("h1",{style:{margin:0,fontSize:"1.3rem",fontWeight:"600"},children:"Chat ClienÈ›i"})]}),t.jsxs("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",fontSize:"0.85rem"},children:[t.jsx("input",{type:"date",value:f,onChange:e=>N(e.target.value),style:{padding:"0.4rem",borderRadius:"20px",border:"none",background:"rgba(255,255,255,0.2)",color:"white",fontSize:"0.85rem"}}),t.jsx("input",{type:"date",value:m,onChange:e=>F(e.target.value),style:{padding:"0.4rem",borderRadius:"20px",border:"none",background:"rgba(255,255,255,0.2)",color:"white",fontSize:"0.85rem"}}),t.jsx("input",{type:"text",value:x,onChange:e=>P(e.target.value),placeholder:"Cod operator",style:{padding:"0.4rem 0.8rem",borderRadius:"20px",border:"none",background:"rgba(255,255,255,0.2)",color:"white",fontSize:"0.85rem",flex:1,minWidth:"120px"}})]})]}),L?t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"white"},children:t.jsx("div",{className:"spinner"})}):t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:window.innerWidth<768?"column":"row",overflow:"hidden"},children:[t.jsx("div",{style:{width:window.innerWidth<768?"100%":"320px",height:window.innerWidth<768&&r?"0":"auto",display:window.innerWidth<768&&r?"none":"block",overflowY:"auto",background:"#151b3d",borderRight:window.innerWidth>=768?"1px solid rgba(255,255,255,0.1)":"none"},children:_.length===0?t.jsx("p",{style:{color:"#888",textAlign:"center",padding:"2rem"},children:"Nu existÄƒ conversaÈ›ii"}):_.map(e=>t.jsxs("div",{onClick:()=>w(e),style:{padding:"1rem",background:r?.id===e.id?"linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%)":"transparent",borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"all 0.2s",":hover":{background:"rgba(255,255,255,0.05)"}},onMouseEnter:n=>{r?.id!==e.id&&(n.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:n=>{r?.id!==e.id&&(n.currentTarget.style.background="transparent")},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.3rem"},children:[t.jsx("span",{style:{fontSize:"1.2rem"},children:"ðŸ“±"}),t.jsx("span",{style:{fontWeight:"600",color:"white",fontSize:"0.95rem"},children:e.client_phone}),e.unread_count_for_operator>0&&t.jsx("span",{style:{background:"#4CAF50",color:"white",padding:"0.1rem 0.5rem",borderRadius:"12px",fontSize:"0.75rem",fontWeight:"bold"},children:e.unread_count_for_operator})]}),t.jsx("div",{style:{fontSize:"0.8rem",color:"#888",marginLeft:"1.7rem"},children:e.assigned_operator_code})]},e.id))}),r&&t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",background:"#0a0e27",position:"relative"},children:[t.jsxs("div",{style:{padding:"1rem",background:"#151b3d",borderBottom:"1px solid rgba(255,255,255,0.1)",display:"flex",alignItems:"center",gap:"0.5rem"},children:[window.innerWidth<768&&t.jsx("button",{onClick:()=>w(null),style:{background:"transparent",border:"none",color:"white",fontSize:"1.5rem",cursor:"pointer",padding:"0",marginRight:"0.5rem"},children:"â†"}),t.jsxs("div",{style:{flex:1},children:[t.jsxs("div",{style:{fontWeight:"600",color:"white",fontSize:"1rem"},children:["ðŸ“± ",r.client_phone]}),t.jsx("div",{style:{fontSize:"0.75rem",color:"#888"},children:r.assigned_operator_code})]})]}),t.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"1rem",background:"linear-gradient(180deg, #0a0e27 0%, #151b3d 100%)"},children:[A.map(e=>t.jsx("div",{style:{marginBottom:"1rem",display:"flex",justifyContent:e.sender_type==="CLIENT"?"flex-start":"flex-end"},children:t.jsxs("div",{style:{maxWidth:"75%",padding:"0.75rem 1rem",borderRadius:e.sender_type==="CLIENT"?"18px 18px 18px 4px":"18px 18px 4px 18px",background:e.sender_type==="CLIENT"?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":e.sender_type==="AI"?"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)":"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",color:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"},children:[t.jsxs("div",{style:{fontSize:"0.7rem",opacity:.8,marginBottom:"0.3rem"},children:[e.sender_type," â€¢ ",q(e.timestamp)]}),t.jsx("div",{style:{fontSize:"0.95rem",lineHeight:"1.4"},children:e.content})]})},e.id)),t.jsx("div",{ref:C})]}),t.jsxs("div",{style:{padding:"0.75rem",background:"#151b3d",borderTop:"1px solid rgba(255,255,255,0.1)",display:"flex",gap:"0.5rem",overflowX:"auto",flexWrap:"nowrap"},children:[t.jsx("button",{onClick:O,style:{padding:"0.6rem 1rem",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",color:"white",border:"none",borderRadius:"20px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"600",whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(102, 126, 234, 0.3)"},children:"ðŸ¤– Date petrecere"}),t.jsx("button",{onClick:H,style:{padding:"0.6rem 1rem",background:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",color:"white",border:"none",borderRadius:"20px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"600",whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(240, 147, 251, 0.3)"},children:"ðŸ“œ Istoric"}),t.jsx("button",{onClick:V,style:{padding:"0.6rem 1rem",background:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",color:"white",border:"none",borderRadius:"20px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"600",whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(79, 172, 254, 0.3)"},children:"ðŸŽ¤ Transcriere"})]}),t.jsx("div",{style:{padding:"1rem",background:"#151b3d",borderTop:"1px solid rgba(255,255,255,0.1)"},children:K?t.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[t.jsx("input",{type:"text",value:s,onChange:e=>S(e.target.value),onKeyPress:e=>e.key==="Enter"&&!e.shiftKey&&k(),placeholder:"Scrie mesaj...",disabled:g,style:{flex:1,padding:"0.75rem 1rem",borderRadius:"25px",border:"none",background:"rgba(255,255,255,0.1)",color:"white",fontSize:"0.95rem",outline:"none"}}),t.jsx("button",{onClick:k,disabled:g||!s.trim(),style:{width:"50px",height:"50px",borderRadius:"50%",background:s.trim()?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"rgba(255,255,255,0.1)",color:"white",border:"none",cursor:g||!s.trim()?"not-allowed":"pointer",fontSize:"1.3rem",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:s.trim()?"0 2px 8px rgba(102, 126, 234, 0.4)":"none",transition:"all 0.2s"},children:g?"â³":"ðŸ“¤"})]}):t.jsx("div",{style:{textAlign:"center",color:"#888",padding:"0.5rem",fontSize:"0.9rem"},children:"ðŸ”’ Doar operatorul rezervant poate rÄƒspunde"})})]}),!r&&window.innerWidth>=768&&t.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#888",fontSize:"1.1rem"},children:t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"ðŸ’¬"}),t.jsx("div",{children:"SelecteazÄƒ o conversaÈ›ie"})]})})]})]})}export{ee as default};
