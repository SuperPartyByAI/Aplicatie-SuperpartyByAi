#!/bin/bash

# Git Hook: Pre-Push
# RuleazÄƒ automat Ã®nainte de fiecare push
# VerificÄƒ cÄƒ testele trec È™i codul e deployment-ready

set -e

echo "ğŸš€ Pre-Push Hook: Verificare deployment-ready..."

# 1. VerificÄƒ cÄƒ suntem Ã®n directorul corect
if [ ! -d "kyc-app/kyc-app" ]; then
  echo "âš ï¸  Nu gÄƒsesc directorul kyc-app/kyc-app"
  echo "   RuleazÄƒ din root-ul repository-ului"
  exit 1
fi

# 2. RuleazÄƒ testele
echo "ğŸ§ª Rulare teste..."
cd kyc-app/kyc-app

if ! npm test -- --run 2>&1 | tee /tmp/test-output.log; then
  echo ""
  echo "âŒ ERROR: Testele au FAILED!"
  echo "   Fix testele Ã®nainte de push."
  echo ""
  echo "ğŸ“‹ Teste failed:"
  grep "FAIL" /tmp/test-output.log || true
  exit 1
fi

# 3. VerificÄƒ cÄƒ package.json e valid
echo "ğŸ“¦ Verificare package.json..."
if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"; then
  echo "âŒ ERROR: package.json invalid!"
  exit 1
fi

# 4. VerificÄƒ cÄƒ nu existÄƒ dependenÈ›e vulnerabile (opÈ›ional, poate fi lent)
# echo "ğŸ”’ Verificare vulnerabilitÄƒÈ›i..."
# npm audit --audit-level=high || echo "âš ï¸  VulnerabilitÄƒÈ›i detectate (nu blocheazÄƒ push-ul)"

# 5. VerificÄƒ cÄƒ branch-ul e up-to-date cu remote
echo "ğŸ”„ Verificare sync cu remote..."
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if git fetch origin "$BRANCH" 2>/dev/null; then
  LOCAL=$(git rev-parse @)
  REMOTE=$(git rev-parse @{u} 2>/dev/null || echo "")
  
  if [ -n "$REMOTE" ] && [ "$LOCAL" != "$REMOTE" ]; then
    echo "âš ï¸  WARNING: Branch-ul tÄƒu nu e sync cu remote"
    echo "   ConsiderÄƒ sÄƒ faci git pull Ã®nainte de push"
  fi
fi

cd ../..

echo "âœ… Pre-Push verificÄƒri complete!"
echo "âœ… Codul e deployment-ready!"
echo ""
