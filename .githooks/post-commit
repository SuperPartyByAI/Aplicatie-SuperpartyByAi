#!/bin/bash

# Git Hook: Post-Commit
# RuleazÄƒ automat DUPÄ‚ fiecare commit
# SalveazÄƒ automat conversaÈ›ia È™i context

set -e

echo ""
echo "ðŸ’¾ Post-Commit Hook: Auto-save sesiune..."

# VerificÄƒ dacÄƒ existÄƒ fiÈ™iere de salvat
if [ ! -f "CURRENT_SESSION.md" ] && [ ! -f "SNAPSHOT.json" ]; then
  echo "âš ï¸  Niciun fiÈ™ier de salvat (CURRENT_SESSION.md sau SNAPSHOT.json lipsesc)"
  echo "   Skip auto-save"
  exit 0
fi

# CreeazÄƒ timestamp
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
DATE=$(date +"%Y-%m-%d")

# SalveazÄƒ conversaÈ›ia dacÄƒ existÄƒ
if [ -f "CURRENT_SESSION.md" ]; then
  mkdir -p .ai-memory/conversations
  cp CURRENT_SESSION.md .ai-memory/conversations/${DATE}_auto-save.md
  echo "âœ… ConversaÈ›ie salvatÄƒ: ${DATE}_auto-save.md"
fi

# SalveazÄƒ snapshot dacÄƒ existÄƒ
if [ -f "SNAPSHOT.json" ]; then
  mkdir -p .ai-memory/snapshots
  cp SNAPSHOT.json .ai-memory/snapshots/${DATE}_${TIMESTAMP}.json
  cp SNAPSHOT.json .ai-memory/snapshots/latest.json
  echo "âœ… Snapshot salvat: ${DATE}_${TIMESTAMP}.json"
fi

# SalveazÄƒ context curent
if [ -f "TODO.md" ]; then
  mkdir -p .ai-memory/context
  cp TODO.md .ai-memory/context/pending-tasks.md
  echo "âœ… TODO salvat"
fi

# ActualizeazÄƒ index
mkdir -p .ai-memory/conversations
cat > .ai-memory/conversations/index.json <<EOF
{
  "last_updated": "$TIMESTAMP",
  "total_sessions": $(ls -1 .ai-memory/conversations/*.md 2>/dev/null | wc -l),
  "latest_session": "$(ls -1t .ai-memory/conversations/*.md 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo 'none')"
}
EOF

echo "âœ… Auto-save complet!"
echo ""
